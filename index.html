<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allen Spelling Bee — Nebula Edition</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- 開場動畫 -->
  <div id="intro-screen">
    <canvas id="intro-nebula"></canvas>
    <div id="intro-text">Welcome, Allen! — Nebula Edition</div>
  </div>

  <!-- 星雲背景 -->
  <canvas id="nebula-bg"></canvas>

  <!-- 主頁內容 -->
  <div id="app" style="display:none">
    <h1 class="big">🌀 Allen Spelling Bee</h1>

    <div class="card">
      <h2>📚 分週練習</h2>
      <div id="weekButtons"></div>
    </div>

    <div class="card">
      <h2>🔥 每日挑戰</h2>
      <button class="btn" onclick="startDaily()">開始挑戰（20 題）</button>
    </div>

    <div class="card">
      <h2>🏅 我的統計</h2>
      <div id="statsArea"></div>
    </div>

    <div class="card">
      <h2>🎁 小商店</h2>
      <button class="btn" onclick="openStore()">進入小商店</button>
    </div>
  </div>

  <!-- Script -->
  <script>
  const $ = s => document.querySelector(s);
  const app = $("#app");
  let STATE = { mode:"menu", week:null, list:[], index:0, correct:0, total:0 };

  window.addEventListener("DOMContentLoaded", ()=>{
    setTimeout(()=>{
      $("#intro-screen").style.display="none";
      $("#app").style.display="block";
      initApp();
    },3500);
  });

  function initApp(){
    app.innerHTML = `
      <h1 class="big">🌀 Allen Spelling Bee</h1>
      <div class="card">
        <h2>📚 分週練習</h2>
        <div id="weekButtons"></div>
      </div>
      <div class="card">
        <h2>🔥 每日挑戰</h2>
        <button class="btn" onclick="startDaily()">開始挑戰（20 題）</button>
      </div>
      <div class="card">
        <h2>🏅 我的統計</h2>
        <div id="statsArea"></div>
      </div>
      <div class="card">
        <h2>🎁 小商店</h2>
        <button class="btn" onclick="openStore()">進入小商店</button>
      </div>`;
    renderWeekButtons(); renderStats();
  }

  function renderWeekButtons(){
    const container=$("#weekButtons");
    container.innerHTML=Object.keys(BANKS)
      .map(wk=>`<button class="btn" onclick="startWeek('${wk}')">Week ${wk}</button>`)
      .join(" ");
  }

  function startWeek(week){
    STATE={mode:"week",week, list:shuffle([...BANKS[week]]),index:0,correct:0,total:0};
    showQuestion();
  }

  function startDaily(){
    STATE={mode:"daily",week:null,list:shuffle(loadAllWords()).slice(0,20),index:0,correct:0,total:0};
    showQuestion();
  }

  function showQuestion(){
    if(STATE.index>=STATE.list.length)return showResult();
    const w=STATE.list[STATE.index];
    const header = STATE.mode==="daily" ? "🔥 每日挑戰" : `Week ${STATE.week}`;
    app.innerHTML=`
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>${header}</h2>
          <button class="btn small" onclick="confirmBack()">返回</button>
        </div>
        <p>第 ${STATE.index+1} / ${STATE.list.length} 題</p>
        <input id="ans" class="input" placeholder="輸入英文單字" autocomplete="off"
          onkeydown="if(event.key==='Enter'){checkAns();}">
        <div style="margin-top:10px;">
          <button class="btn" onclick="speak('${w.word}')">🔊 播放發音</button>
          <button class="btn" onclick="checkAns()">確認</button>
        </div>
        <div id="feedback" class="small" style="margin-top:12px;min-height:50px;"></div>
      </div>`;
    speak(w.word); $("#ans").focus();
  }

  function checkAns(){
    const input=$("#ans").value.trim().toLowerCase();
    if(!input)return;
    const w=STATE.list[STATE.index];
    const ok=input===w.word.toLowerCase();
    STATE.total++;
    let fb="";
    if(ok){STATE.correct++;fb=`<span style="color:#5bd68a">✔ 正確！</span> ${w.meaning}`;}
    else{fb=`<span style="color:#ff6b6b">✘ 錯誤</span> 正確答案：${w.word} (${w.meaning})`;}
    $("#feedback").innerHTML=`
      ${fb}
      <br><br>
      <button class="btn" onclick="nextQuestion()">下一題 ➜</button>`;
  }

  function nextQuestion(){STATE.index++;showQuestion();}

  function confirmBack(){
    if(confirm("確定要返回主頁嗎？\n目前進度將不會保存。")) initApp();
  }

  function showResult(){
    const rate=Math.round((STATE.correct/STATE.total)*100);
    const modeText=STATE.mode==="daily"?"每日挑戰":`Week ${STATE.week}`;
    app.innerHTML=`
      <div class="card">
        <h2>✅ ${modeText} 完成</h2>
        <p>答對 ${STATE.correct}/${STATE.total} 題 (${rate}%)</p>
        <button class="btn" onclick="initApp()">回主頁</button>
      </div>`;
  }

  function loadAllWords(){
    const all=[];for(const k in BANKS)(BANKS[k]||[]).forEach(it=>all.push(it));
    return all;
  }

  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

  function speak(t){const
