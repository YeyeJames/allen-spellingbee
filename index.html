<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allen Spelling Bee â€” Nebula Edition</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    #recordingStatus {
      color: #ffd65b;
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
      animation: blink 1s infinite alternate;
    }
    @keyframes blink {
      from { opacity: 1; }
      to { opacity: 0.5; }
    }
    .pulse { animation: pulse 1s ease-out 3; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(91,214,138,0.6); }
      70% { box-shadow: 0 0 10px 10px rgba(91,214,138,0); }
      100% { box-shadow: 0 0 0 0 rgba(91,214,138,0); }
    }
    .coin-rule {
      font-size: 13px;
      color: #ffd65b;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 6px 10px;
      margin-top: 4px;
      line-height: 1.4em;
    }
  </style>
</head>
<body>
  <!-- é–‹å ´å‹•ç•« -->
  <div id="intro-screen">
    <canvas id="intro-nebula"></canvas>
    <div id="intro-text">Welcome, Allen! â€” Nebula Edition</div>
  </div>

  <!-- æ˜Ÿé›²èƒŒæ™¯ -->
  <canvas id="nebula-bg"></canvas>

  <!-- ä¸»é å…§å®¹ -->
  <div id="app" style="display:none">
    <h1 class="big">ğŸŒ€ Allen Spelling Bee</h1>

    <div class="card">
      <h2>ğŸ“š åˆ†é€±ç·´ç¿’</h2>
      <div id="weekButtons"></div>
    </div>

    <div class="card">
      <h2>ğŸ”¥ æ¯æ—¥æŒ‘æˆ°</h2>
      <button class="btn" onclick="startDaily()">é–‹å§‹æŒ‘æˆ°ï¼ˆ20 é¡Œï¼‰</button>
    </div>

    <div class="card">
      <h2>ğŸ… æˆ‘çš„çµ±è¨ˆ</h2>
      <div id="statsArea"></div>
    </div>

    <div class="card">
      <h2>ğŸ å°å•†åº—</h2>
      <button class="btn" onclick="openStore()">é€²å…¥å°å•†åº—</button>
    </div>
  </div>

  <!-- Script -->
  <script>
  const $ = s => document.querySelector(s);
  const app = $("#app");
  let STATE = { mode:"menu", week:null, list:[], index:0, correct:0, total:0, streak:0 };
  let recorder, countdownTimer, timeLeft = 10;

  window.addEventListener("DOMContentLoaded", ()=>{
    setTimeout(()=>{
      $("#intro-screen").style.display="none";
      $("#app").style.display="block";
      initApp();
    },3500);
  });

function initApp() {
  app.innerHTML = `
    <h1 class="big" style="margin-bottom: 30px;">ğŸŒ€ Allen Spelling Bee</h1>

    <div id="menuGrid">

      <div class="menu-item" onclick="openWeekMenu()">
        <div class="icon">ğŸ“š</div>
        <div class="title">åˆ†é€±ç·´ç¿’</div>
        <div class="desc">é¸æ“‡è¦ç·´ç¿’çš„é€±æ¬¡å–®å­—</div>
      </div>

      <div class="menu-item" onclick="startDaily()">
        <div class="icon">ğŸ”¥</div>
        <div class="title">æ¯æ—¥æŒ‘æˆ°</div>
        <div class="desc">é™æ™‚ 20 é¡Œæ‹¼å­—æŒ‘æˆ°</div>
      </div>

      <div class="menu-item" onclick="showMissions()">
        <div class="icon">ğŸ“‹</div>
        <div class="title">ä»Šæ—¥ä»»å‹™</div>
        <div class="desc">æŸ¥çœ‹å­¸ç¿’ä»»å‹™èˆ‡çå‹µ</div>
      </div>

      <div class="menu-item" onclick="openStore()">
        <div class="icon">ğŸ</div>
        <div class="title">å°å•†åº—</div>
        <div class="desc">ç”¨å–®å­—å¹£è³¼è²·ç‰¹æ•ˆèˆ‡é€ å‹</div>
      </div>

      <div class="menu-item" onclick="showStats()">
        <div class="icon">ğŸ…</div>
        <div class="title">æˆ‘çš„çµ±è¨ˆ</div>
        <div class="desc">æŸ¥çœ‹ç·´ç¿’æ¬¡æ•¸èˆ‡æ­£ç¢ºç‡</div>
      </div>

    </div>
  `;

  // æ›´æ–°é‡‘å¹£æ•¸
  const coins = parseInt(localStorage.getItem("allen_coins") || 0);
  const coinBar = document.createElement("div");
  coinBar.id = "coinBar";
  coinBar.innerHTML = `ğŸ’° å–®å­—å¹£ï¼š<b>${coins}</b>`;
  app.prepend(coinBar);

  dispatchEvent(new CustomEvent("allen:start"));
}

  function renderWeekButtons(){
    const container=$("#weekButtons");
    container.innerHTML=Object.keys(BANKS)
      .map(wk=>`<button class="btn" onclick="startWeek('${wk}')">Week ${wk}</button>`)
      .join(" ");
  }

  function startWeek(week){
    STATE={mode:"week",week, list:shuffle([...BANKS[week]]),index:0,correct:0,total:0,streak:0};
    showQuestion();
  }

  function startDaily(){
    STATE={mode:"daily",week:null,list:shuffle(loadAllWords()).slice(0,20),index:0,correct:0,total:0,streak:0};
    showQuestion();
  }

  function showQuestion(){
    if(STATE.index>=STATE.list.length)return showResult();
    const w=STATE.list[STATE.index];
    const header = STATE.mode==="daily" ? "ğŸ”¥ æ¯æ—¥æŒ‘æˆ°" : `Week ${STATE.week}`;
    app.innerHTML=`
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>${header}</h2>
          <button class="btn small" onclick="confirmBack()">è¿”å›</button>
        </div>
        <div class="coin-rule">
          ğŸ’° å–®å­—å¹£è¦å‰‡ï¼š<br>
          é€£çºŒç­”å° 1â€“4 é¡Œ â†’ +1 å¹£ï¼›5â€“9 é¡Œ â†’ +2 å¹£ï¼›10 é¡Œä»¥ä¸Š â†’ +3 å¹£
        </div>
        <p>ç¬¬ ${STATE.index+1} / ${STATE.list.length} é¡Œ</p>
        <input id="ans" class="input" placeholder="è¼¸å…¥è‹±æ–‡å–®å­—" autocomplete="off"
          onkeydown="if(event.key==='Enter'){checkAns();}">
        <div style="margin-top:10px;">
          <button class="btn" onclick="speak('${w.word}')">ğŸ”Š æ’­æ”¾ç™¼éŸ³</button>
          <button class="btn" onclick="checkAns()">ç¢ºèª</button>
        </div>
        <div id="feedback" class="small" style="margin-top:12px;min-height:80px;"></div>
        <div id="hintArea" style="margin-top:8px;">
          <button class="btn" onclick="playHint('${w.word}')">ğŸ’¡ æç¤º</button>
          <button class="btn" id="recordBtn" onclick="recordHint('${w.word}')">ğŸ™ï¸ éŒ„éŸ³æç¤º</button>
          <div id="recordingStatus"></div>
        </div>
      </div>`;
    speak(w.word); $("#ans").focus();
  }

  // === å–®å­—å¹£åŠ æˆé‚è¼¯ ===
  function rewardCoins(){
    const c = parseInt(localStorage.getItem("allen_coins") || "0", 10);
    let bonus = 1;
    if (STATE.streak >= 10) bonus = 3;
    else if (STATE.streak >= 5) bonus = 2;
    const newCoins = c + bonus;
    localStorage.setItem("allen_coins", newCoins);
    return bonus;
  }

  function checkAns(){
    const input=$("#ans").value.trim().toLowerCase();
    if(!input)return;
    const w=STATE.list[STATE.index];
    const ok=input===w.word.toLowerCase();
    STATE.total++;
    let fb="", bonusText="";
    if(ok){
      STATE.correct++;
      STATE.streak++;
      const bonus = rewardCoins();
      bonusText = `ğŸ’° +${bonus} å¹£ï¼ï¼ˆé€£çºŒ ${STATE.streak} é¡Œæ­£ç¢ºï¼‰`;
      fb=`<span style="color:#5bd68a">âœ” æ­£ç¢ºï¼</span> ${w.meaning}<br>${bonusText}`;
    } else {
      fb=`<span style="color:#ff6b6b">âœ˜ éŒ¯èª¤</span> æ­£ç¢ºç­”æ¡ˆï¼š${w.word} (${w.meaning})<br>ğŸ’” é€£å‹æ­¸é›¶`;
      STATE.streak = 0;
    }
    $("#feedback").innerHTML=`
      ${fb}
      <br><br>
      <button class="btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ âœ</button>`;
  }

  function nextQuestion(){STATE.index++;showQuestion();}

  function confirmBack(){
    if(confirm("ç¢ºå®šè¦è¿”å›ä¸»é å—ï¼Ÿ\nç›®å‰é€²åº¦å°‡ä¸æœƒä¿å­˜ã€‚")) initApp();
  }

  function playHint(word){
    const saved = localStorage.getItem("hint_"+word);
    if(!saved){ alert("âš ï¸ å°šç„¡æç¤ºéŒ„éŸ³"); return; }
    const audio = new Audio(saved);
    audio.play();
  }

  // === éŒ„éŸ³æç¤ºï¼ˆå«å€’æ•¸èˆ‡å‹•ç•«ï¼‰===
  function recordHint(word){
    const btn = $("#recordBtn");
    const status = $("#recordingStatus");
    if(btn.dataset.recording === "true"){ stopRecording(word, btn, status); return; }

    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert("ç„¡æ³•ä½¿ç”¨éŒ„éŸ³åŠŸèƒ½"); return;
    }
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      recorder = new MediaRecorder(stream);
      const chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/mp3' });
        const reader = new FileReader();
        reader.onloadend = () => {
          localStorage.setItem("hint_"+word, reader.result);
          btn.classList.add("pulse");
          status.textContent = "âœ… éŒ„éŸ³å·²å„²å­˜ï¼";
          const a = new Audio(reader.result);
          a.play();
          setTimeout(()=>{btn.classList.remove("pulse");status.textContent="";},2000);
        };
        reader.readAsDataURL(blob);
      };
      recorder.start();
      btn.textContent = "â¹ï¸ åœæ­¢éŒ„éŸ³";
      btn.dataset.recording = "true";
      timeLeft = 10;
      status.textContent = `ğŸ™ï¸ éŒ„éŸ³ä¸­â€¦ (${timeLeft})`;
      countdownTimer = setInterval(()=>{
        timeLeft--;
        status.textContent = `ğŸ™ï¸ éŒ„éŸ³ä¸­â€¦ (${timeLeft})`;
        if(timeLeft<=0) stopRecording(word, btn, status);
      },1000);
    }).catch(()=>alert("éŒ„éŸ³æ¬Šé™è¢«æ‹’çµ•"));
  }

  function stopRecording(word, btn, status){
    clearInterval(countdownTimer);
    if(recorder && recorder.state==="recording") recorder.stop();
    btn.textContent = "ğŸ™ï¸ éŒ„éŸ³æç¤º";
    btn.dataset.recording = "false";
    status.textContent = "";
  }

  function showResult(){
    const rate=Math.round((STATE.correct/STATE.total)*100);
    const modeText=STATE.mode==="daily"?"æ¯æ—¥æŒ‘æˆ°":`Week ${STATE.week}`;
    app.innerHTML=`
      <div class="card">
        <h2>âœ… ${modeText} å®Œæˆ</h2>
        <p>ç­”å° ${STATE.correct}/${STATE.total} é¡Œ (${rate}%)</p>
        <button class="btn" onclick="initApp()">å›ä¸»é </button>
      </div>`;
  }

  function loadAllWords(){
    const all=[];for(const k in BANKS)(BANKS[k]||[]).forEach(it=>all.push(it));
    return all;
  }
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
  function speak(t){const u=new SpeechSynthesisUtterance(t);u.lang="en-US";u.rate=0.9;u.pitch=1;speechSynthesis.cancel();speechSynthesis.speak(u);}
  function renderStats(){
    const s=JSON.parse(localStorage.getItem("allen_stats")||'{"runs":0,"avg":0}');
    $("#statsArea").innerHTML=`<p>ç´¯ç©ç·´ç¿’æ¬¡æ•¸ï¼š${s.runs||0}</p><p>å¹³å‡æ­£ç¢ºç‡ï¼š${s.avg?s.avg.toFixed(1):0}%</p><button class="btn" onclick="clearStats()">æ¸…é™¤ç´€éŒ„</button>`;
  }
  function clearStats(){localStorage.removeItem("allen_stats");renderStats();}
  </script>

  <script src="banks.js"></script>
  <script src="script-store.js"></script>
  <script src="meow-teacher.js"></script>
  <script src="missions.js"></script>
</body>
</html>
