<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allen Spelling Bee — 星空主選單版</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- 星空背景 -->
  <canvas id="stars"></canvas>

  <!-- 主內容 -->
  <div id="app">
    <h1 class="big">🌀 Allen Spelling Bee</h1>

    <div id="coinBar">💰 單字幣：<b>0</b></div>

    <div id="menuGrid">
      <div class="menu-item" onclick="showWeeks()">
        <div class="icon">📚</div>
        <div class="title">分週練習</div>
        <div class="desc">選擇要練習的週次單字</div>
      </div>

      <div class="menu-item" onclick="startDaily()">
        <div class="icon">🔥</div>
        <div class="title">每日挑戰</div>
        <div class="desc">限時 20 題拼字挑戰</div>
      </div>

      <div class="menu-item" onclick="showMissions()">
        <div class="icon">📋</div>
        <div class="title">今日任務</div>
        <div class="desc">查看學習任務與獎勵</div>
      </div>

      <div class="menu-item" onclick="openStore()">
        <div class="icon">🎁</div>
        <div class="title">小商店</div>
        <div class="desc">用單字幣購買特效與造型</div>
      </div>

      <div class="menu-item" onclick="showStats()">
        <div class="icon">🏅</div>
        <div class="title">我的統計</div>
        <div class="desc">查看練習次數與正確率</div>
      </div>
    </div>
  </div>

  <!-- === 主要腳本 === -->
  <script>
  const $ = s => document.querySelector(s);
  const app = $("#app");

  window.addEventListener("DOMContentLoaded", ()=>{
    updateCoins();
    dispatchEvent(new CustomEvent("allen:start"));
    startStars();
  });

  function updateCoins(){
    const coins=parseInt(localStorage.getItem("allen_coins")||0);
    $("#coinBar").innerHTML=`💰 單字幣：<b>${coins}</b>`;
  }

  // === 顯示分週練習 ===
  function showWeeks(){
    const weeksHTML = Object.keys(BANKS)
      .map(w=>`<button class="btn" onclick="startWeek('${w}')">Week ${w}</button>`)
      .join(" ");
    app.innerHTML = `
      <h1 class="big">📚 分週練習</h1>
      <div class="card">
        <div style="text-align:center;margin-bottom:16px;">請選擇要練習的週次：</div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
          ${weeksHTML}
        </div>
      </div>
      <button class="btn" style="margin-top:20px;" onclick="initApp()">返回主選單</button>
    `;
  }

  // === 開始某週練習 ===
  function startWeek(week){
    STATE={mode:"week",week,list:shuffle([...BANKS[week]]),index:0,correct:0,total:0,streak:0};
    showQuestion();
  }

  // === 每日挑戰 ===
  function startDaily(){
    STATE={mode:"daily",week:null,list:shuffle(loadAllWords()).slice(0,20),index:0,correct:0,total:0,streak:0};
    showQuestion();
  }

  // === 顯示統計 ===
  function showStats(){
    const s=JSON.parse(localStorage.getItem("allen_stats")||'{"runs":0,"avg":0}');
    app.innerHTML=`
      <h1 class="big">🏅 我的統計</h1>
      <div class="card">
        <p>累積練習次數：${s.runs||0}</p>
        <p>平均正確率：${s.avg?s.avg.toFixed(1):0}%</p>
        <button class="btn" onclick="clearStats()">清除紀錄</button>
      </div>
      <button class="btn" onclick="initApp()">返回主選單</button>
    `;
  }

  function clearStats(){
    localStorage.removeItem("allen_stats");
    showStats();
  }

  // === 工具 ===
  function loadAllWords(){
    const all=[];for(const k in BANKS)(BANKS[k]||[]).forEach(it=>all.push(it));
    return all;
  }
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

  // === 星空背景 ===
  function startStars(){
    const canvas=document.getElementById('stars');
    const ctx=canvas.getContext('2d');
    let w,h; const stars=[];
    function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
    window.addEventListener('resize',resize); resize();
    for(let i=0;i<60;i++){stars.push({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.5,s:Math.random()*0.5+0.2});}
    function draw(){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="#ffffff";
      stars.forEach(star=>{
        ctx.globalAlpha=Math.random()*0.5+0.3;
        ctx.beginPath();ctx.arc(star.x,star.y,star.r,0,Math.PI*2);ctx.fill();
        star.y+=star.s;if(star.y>h)star.y=0;
      });
      requestAnimationFrame(draw);
    }
    draw();
  }
  </script>

  <!-- === 模組 === -->
  <script src="banks.js"></script>
  <script src="script-store.js"></script>
  <script src="meow-teacher.js"></script>
  <script src="missions.js"></script>
</body>
</html>